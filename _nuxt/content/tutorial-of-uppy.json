{
  "title": "Uppy - 最方便的上傳套件",
  "bgImageUrl": "/images/11/11-0.jpg",
  "meta": {
    "index": 2,
    "fileName": "2019-06-16-TutorialOfUppy.md",
    "section": "/",
    "dirName": "/"
  },
  "date": "2019-06-16",
  "path": "/tutorial-of-uppy",
  "permalink": "/tutorial-of-uppy",
  "anchors": [],
  "body": "<p>一直以來，我都覺得上傳檔案的程式開發，是表單處理中的痛點，一般的&lt;input type=“file” /&gt;的功能比較簡略，介面不甚美觀。之前有發現Uppy這個套件，就對它感興趣，現在已經出了1.0版，想寫篇文章記錄一下心得。</p>\n<p>這篇的文章的原始碼在這邊<a href=\"https://github.com/thomascsd/ngx-uppy-demo\">ngx-uppy-demo</a></p>\n<h2>安裝</h2>\n<pre class=\"language-sh\"><code class=\"language-sh\">npm install uppy\n</code></pre>\n<p>當執行npm install uppy時，是安裝Uppy的全部功能，這當然會使得安裝的檔案容量變大。</p>\n<pre class=\"language-sh\"><code class=\"language-sh\">npm install @uppy/core @uppy/dashboard @uppy/xhr-upload\n</code></pre>\n<p>一般的作法，就是安裝所需的套件，如果想要使用Dashboard，可以只安裝@uppy/dashboard及@uppy/xhr-upload。</p>\n<pre class=\"language-sh\"><code class=\"language-sh\">npm install @uppy/file-input @uppy/progress-bar @uppy/xhr-upload\n</code></pre>\n<p>如果只想要使用一般的FileUpload，可以只安裝@uppy/file-input @uppy/progress-bar @uppy/xhr-upload</p>\n<h2>實作</h2>\n<h3>Angular</h3>\n<pre class=\"language-javascript\"><code class=\"language-javascript\">@<span class=\"token function\">Component</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  selector<span class=\"token punctuation\">:</span> <span class=\"token string\">'app-uppy'</span><span class=\"token punctuation\">,</span>\n  templateUrl<span class=\"token punctuation\">:</span> <span class=\"token string\">'./uppy.component.html'</span><span class=\"token punctuation\">,</span>\n  styleUrls<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'./uppy.component.scss'</span><span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">UppyComponent</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">AfterViewInit</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">ngAfterViewInit</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">void</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// Create Uppy object</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<p>因為擅長的是Angular，所以這個範例，想將Angular和Uppy整合，所以首先實作AfterViewInit，確認頁面的DOM都戴入完成後，才能建立Uppy的物件。</p>\n<h3>Dashboard</h3>\n<pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>container<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>uploadContainer<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n</code></pre>\n<pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">import</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">as</span> Uppy <span class=\"token keyword\">from</span> <span class=\"token string\">'@uppy/core'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">as</span> Dashboard <span class=\"token keyword\">from</span> <span class=\"token string\">'@uppy/dashboard'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">as</span> XHRUpload <span class=\"token keyword\">from</span> <span class=\"token string\">'@uppy/xhr-upload'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> uppy <span class=\"token operator\">=</span> <span class=\"token function\">Uppy</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    autoProceed<span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nuppy<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>Dashboard<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n    inline<span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n    target<span class=\"token punctuation\">:</span> <span class=\"token string\">'.uploadContainer'</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nuppy<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>XHRUpload<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n    endpoint<span class=\"token punctuation\">:</span> <span class=\"token string\">'/api/file'</span><span class=\"token punctuation\">,</span>\n    formData<span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n    fieldName<span class=\"token punctuation\">:</span> <span class=\"token string\">'fileData'</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nuppy<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">'upload-success'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">:</span> any<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>imageDataService<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>response<span class=\"token punctuation\">.</span>body <span class=\"token keyword\">as</span> ImageDatum<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre>\n<p>使用use戴入所需的套件，這裡戴入Dashboard及XHRUpload。</p>\n<pre class=\"language-javascript\"><code class=\"language-javascript\">uppy<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>Dashboard<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n    inline<span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n    target<span class=\"token punctuation\">:</span> <span class=\"token string\">'.uploadContainer'</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre>\n<p>Dashboard的參數可以參考<a href=\"https://uppy.io/docs/dashboard/\">官方文件</a>。</p>\n<ul>\n<li>inline(true)：直接將Dashoboard顯示在頁面上。</li>\n<li>target(’.uploadContainer’)：Dashboard顯示在uploadContainer上。</li>\n</ul>\n<pre class=\"language-javascript\"><code class=\"language-javascript\">uppy<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>XHRUpload<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n    endpoint<span class=\"token punctuation\">:</span> <span class=\"token string\">'/api/file'</span><span class=\"token punctuation\">,</span>\n    formData<span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n    fieldName<span class=\"token punctuation\">:</span> <span class=\"token string\">'fileData'</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nuppy<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">'upload-success'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">:</span> any<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>imageDataService<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>response<span class=\"token punctuation\">.</span>body <span class=\"token keyword\">as</span> ImageDatum<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre>\n<p>XHRUpload的參數可以參考<a href=\"https://uppy.io/docs/xhr-upload/\">文件</a>，<code>endpoint</code>指定Server端的API位置，並且是用監聽事件upload-success來判斷是否上傳成功。如此檔案或是圖片上傳的功能就完成。</p>\n<img class=\"img-responsive\" src=\"/images/11/11-1.png\">\n<p>Dashboard的畫面如上，因為Uppy是上傳套件，無法戴入圖片，所以這邊有使用另一個套件<a href=\"https://github.com/MurhafSousli/ngx-gallery\">ngx-gallery</a>。</p>\n<h3>File Input</h3>\n<pre class=\"language-javascript\"><code class=\"language-javascript\">uppy\n<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>FileInput<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n  pretty<span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n  target<span class=\"token punctuation\">:</span> <span class=\"token string\">'.uploadContainer'</span><span class=\"token punctuation\">,</span>\n  inputName<span class=\"token punctuation\">:</span> <span class=\"token string\">'fileData'</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>Processbar<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n  target<span class=\"token punctuation\">:</span> <span class=\"token string\">'body'</span><span class=\"token punctuation\">,</span>\n  fixed<span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n  hideAfterFinish<span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span>\nl\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nuppy<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>XHRUpload<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n    endpoint<span class=\"token punctuation\">:</span> <span class=\"token string\">'/api/file'</span><span class=\"token punctuation\">,</span>\n    formData<span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n    fieldName<span class=\"token punctuation\">:</span> <span class=\"token string\">'fileData'</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nuppy<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">'upload-success'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">:</span> any<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>imageDataService<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>response<span class=\"token punctuation\">.</span>body <span class=\"token keyword\">as</span> ImageDatum<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre>\n<p>程式碼與Dashboard的很相似，戴入FileInput的套件及設定參數，可以參考<a href=\"https://uppy.io/docs/file-input/\">文件</a>。</p>\n<ul>\n<li>target(’.uploadContainer’)：FileInput顯示在uploadContainer上。</li>\n<li>inputName(‘fileData’)：傳送至Server的名稱為fileData。</li>\n</ul>\n<img class=\"img-responsive\" src=\"/images/11/11-2.png\">\n<p>FileInput的畫面如上。</p>\n<h3>Server</h3>\n<pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">import</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">as</span> fileUpload <span class=\"token keyword\">from</span> <span class=\"token string\">'express-fileupload'</span><span class=\"token punctuation\">;</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span><span class=\"token function\">fileUpload</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre>\n<p>Server端是使用express.js，而處理上傳檔案是用<a href=\"https://github.com/richardgirges/express-fileupload\">express-fileupload</a>這個套件。</p>\n<pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">async</span> <span class=\"token function\">handler</span><span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">:</span> express<span class=\"token punctuation\">.</span>Request<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">:</span> express<span class=\"token punctuation\">.</span>Response<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> fileData <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> req<span class=\"token punctuation\">[</span><span class=\"token string\">'files'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> service <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">FileService</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">const</span> fileRes <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> service<span class=\"token punctuation\">.</span><span class=\"token function\">upload</span><span class=\"token punctuation\">(</span>fileData<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> res<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span>fileRes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n</code></pre>\n<p>只需用req.files.fileData就可以存取到所上傳的物件，而fileData就是在<strong>XHRUpload</strong>套件上所設定fieldName的值。</p>\n<h2>結綸</h2>\n<p>Uppy是目前我覺得很方便的上傳套件，簡單幾段程式就可以實作檔案上傳。</p>\n"
}